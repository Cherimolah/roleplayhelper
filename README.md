# Документация
Бот представляет собой систему менеджмента персонажами в многопользовательской текстовой ролевой игре.  
Создан по заказу специально для сообщества VK: [ссылка](https://vk.com/club209903645)  

Поддерживаются такие фичи как: 
* Создание анкеты персонажа
* Просмотр анкет других пользователей и взаимодействие с другими пользователями
* Система квестов с доп. целями и ежедневными заданиями
* Система особых квестов для дочерей
* Магазин предметов
* Карта экспедитора и экшен-режим. 
* Мощная админ панель с CRUD перациями
контента

Обо всех механиках будет далее

**В проекте используется фреймворки [VKBottle](https://vkbottle.readthedocs.io/ru/latest/),
[Gino](https://python-gino.org/docs/en/1.0/tutorials/tutorial.html) 
(надстройка SQLAlchemy), [Alembic](https://alembic.sqlalchemy.org/en/latest/autogenerate.html) рекомендуется
их изучить перед доработкой проекта**

В коде к функциям написаны докстринги и поясняющие комментарии  
По всем вопросам можно обратиться к разработчику: [VK](https://vk.com/id32650977), [TG](https://t.me/Cherimolah)

## Содержание
1. [Подготовка и запуск проекта](#подготовка-и-запуск-проекта)
2. [Описание структуры проекта](#описание-структуры-проекта)
3. [Описание всех механик](#описание-всех-механик)
   1. [Регистрация пользователей](#регистрация-пользователей)
   2. [Статус Дочь](#статус-дочь)
   3. [Главное меню](#главное-меню)
   4. Админ-панель
   5. Экшен-режим
   6. Система чатов и перемещения
4. Используемые "фреймворки"
    1. Система стейтов
    2. CRUD с объектами контента
5. Структура кастомных данных

## Подготовка и запуск проекта
Описана будет установка на Linux (Ubuntu 24.04), для Windows действия аналогичны

Установите PostgreSQL, и создайте базу данных
```bash
sudo apt install postgresql
sudo -u postgres psql
>> CREATE DATABASE roleplayhelper;
>> ALTER USER postgres WITH PASSWORD 'new_password';
>> \q
```

Важно установить пакет `libpq-dev` для работы Alembic
```bash
sudo apt install libpq-dev
```

Склонируйте репозиторий, создайте окружение, установите зависимости
```bash
git clone git@github.com:Cherimolah/roleplayhelper.git
cd roleplayhelper
python3 -m venv venv
source venv/bin/activate
pip3 install -r requirements.txt
```
Скопируйте файл `.env_sample` под названием `.env` и заполните все переменные  
```bash
cp .env_sample .env
nano .env
```
**Переменную `HALL_CHAT_ID` пока можно не заполнять, её значение получим после запуска бота**

Запускаем бота, чтобы создать таблицы и получить `HALL_CHAT_ID`
```bash
python3 main.py
```
**После запуска отправляем боту сообщение `/chat_id`. В ответ придет число, вписываем его в `.env`**  

Бота останавливаем

Создайте окружение для Alembic
```bash
alembic init alembic
```
Откройте файл `alembic.ini` и укажите URL  базе данных
```bash
nano alembic.ini
# Найдите строку и замените:
sqlalchemy.url = postgres://postgres:PASSWORD@localhost/roleplayhelper
```
Откройте файл `alembic/env.py` и укажите объект метадаты базы данных
```
nano alembic/env.py

# В начало (где все импорты)
from service.db_engine import db
...
target_metadata = db  # Надо найти эту строчку
```

Для работы перезапуска бота по кнопке надо создать unit модуль systemd

Создайте запускаемый файл `startbot`
```bash
touch startbot
chmod +x startbot
nano startbot
```
Вписываем в файл `startbot` код запуска
```bash
#!/bin/bash
cd /root/roleplayhelper  # Путь к папке
source venv/bin/activate
pip3 install -r requirements.txt
alembic revision --autogenerate --head head
alembic upgrade head
python3 main.py
```
Создаем файл модуля systemd
```bash
nano /etc/systemd/system/roleplayhelper.service
```
Вписываем конфиг модуля
```
[Unit]
Description=RolePlay Bot VK

[Service]
ExecStart=/bin/bash /root/roleplayhelper/startbot
KillMode=mixed

[Install]
WantedBy=multiuser.target
```
После этого можем запускать бота
```bash
systemctl restart roleplayhelper
```

Бот пришлет айди чата, его необходимо указать в файл `.env` и перезапустить бота командой
```bash
systemctl restart roleplayhelper
```
После этого пишем боту в личные сообщения `Начать`, проходим регистрацию, и принимаем свою анкету

Для создания миграций базы данных используйте этот код
```bash
alembic revision --autogenerate --head head
alembic upgrade head
```

## Описание структуры проекта
### Корень
В корне проекта используются файлы запуска, загрузки, и определения констант
`main.py` основной запускаемый файл  
`loader.py` файл, где создается бот, загрузчики и другие полезные сущности.
Создаются здесь, чтобы не было цикличного импорта  
`messages.py` файл со строками сообщений. Legacy / Deprecated. Сейчас не используется т.к.
строк уже очень много стало  
`config.py` файл подгружает переменные окружения  
`bot_extended.py` модуль миксинов классов VKBottle. Нужен, чтобы переопределить некоторые
вызовы api, а также другие фичи

### Handlers
Самая большая и главная директория. Здесь лежат все хендлеры  
`questions.py` самый первый файл с хендлерами. Здесь происходит регистрация пользователей, а также возврат в основное меню  
`admin.py` Здесь хендлеры, связанные с действиями админов. Принятие анкеты пользователей,
принятие зарплаты, принятие квестов и еженедельных заданий. Также дополнительные админские хендлеры, по типу указания профессии и каюты при принятии анкеты  
`chat_commands.py` хендлеры, связанные с текстовыми командами.  
`group_events.py` хендлеры, связанные с событиями происходящими с сообществом. На
текущий момент там только автопринятие пользователя в группу

`action_mode` директория с хендлерами, работающими во время экшен-режима
`admin_panel` дериктория с хендлерами для работы админ-панели  
`admin_panel/edit_content`  директория с хендлерами со всеми CRUD операциями
над единицами контента
`judge_panel` директория с хендлерами для работы панели судьи. Но на самом деле
панель судьи это урезанная версия админ-панели, поэтому там один хендлер, который перекидывает в админку,
но ставит флаг, что админка только "судейская"  
`public_menu` аналогично хендлеры, для работы публичного меню, доступны всем пользователям  
`requests` директория с хендлерами для принятия запросов. Вообще сюда было бы правильно перенести принятие запросов
из admin.py, но это как говорится WIP

### Service
Здесь лежат сервисные модули, используемые везде в хендлерах
`custom_rules.py` модуль с кастомными правилами  
`db_engine.py` модуль с базой данных  
`keyboards.py` модуль с клавиатурами и их генераторами (какие-то статические либо генерируемые по шаблону)  
`middleware.py` модуль с мидлварями  
`serializers.py` здесь очень много маленьких функций, они нужны, чтобы красиво выводить объекты из базы данных  
`states.py` здесь хранятся всевозможные стейты  
`utils.py` здесь очень много крутых и полезных функций

## Описание всех механик
Здесь подробно описывается все, что есть в боте
### Регистрация пользователей
При начале работе с ботом пользователь нажимает на кнопку или пишет боту сообщение `Начать`  
Далее бот задает ряд вопросов для заполнения собственной анкеты персонажа (хендлеры со стейтом RegistrationState). Они идут по порядку (практически весь файл `handlers/questions.py`)  
После того как общие вопросы закончатся, пользователю предлагается заполнить вопросы для статуса Дочь (хендлеры со стейтом DaughterQuestions)  
Проверяют и решают принять анкету или нет администраторы. Файл `handlers/admin.py` хендлеры принятия анкеты

Список вопросов можно понять из `service/states.RegistrationStates` или из хендлеров  
Список вопросов для дочерей сложнее, поэтому рекомендуется читать хендлеры в `q1 - q8`

После заполнения анкеты бот переводит пользователя в режим ожидания со стейтом (`Registration.WAIT`).  
Когда администратор примет анкету у пользователя появится доступ в меню  
Администратор при принятии анеты указывает профессию (если она не была указана пользователем), номер каюты и тип каюты
(хендлеры в файле `handlers/admin.py`)  
После указания номера каюты юзербот создает чат каюты пользователя, а также перемещает пользователя в Холл.
Более подробно в разделе механики перемещения

### Статус Дочь
Помимо дефолтного статуса "Резидент", есть особый статус "Дочь❤"  
Это статус для особо активных игроков, т.к. требует больше активности в боте, создан для
разнообразия контента и игры в RolePlay

У дочерей есть два дополнительных параметра (технически они есть у всех, но у резидентов они равны нулю и не несут смысла).  
*Либидо* и *Подчинение*  
Эти параметры выражены числом от 0 до 100 включительно и растут с каждым днем  
Дочерям необходимо выполнять специальные квесты для дочерей, которые по мере увеличения этих параметров будут усложняться.  
За выполнение квеста подразумевается, что их параметры будут убывать  
Функция `service/utils.update_daughter_levels` описывает обновление параметров и контроль выполнения квеста

При регистрации, пользователь отвечает на несколько вопросов. В зависимости от своих ответов, у него будет формироваться
так называемый "бонус" к обоим параметрам. Этот бонус будет участвовать в формуле обновления параметров дочерей

Формула (для либидо аналогичная): 
```
sub_level = sub_level + 2 + 2 * multiplier + sub_bonus
Где:
sub_level - текущий уровень подчинения, принадлежит промежутку [0; 100]
multiplier - множитель фракции, в которой состоит Дочь (указывается при создании фракции)
sub_bonus - набранные очки при регистрации
```

## Главное меню
